<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Service Management (Alpine + sql.js + PayPal demo)</title>

  <!-- Tailwind (cdn for quick hosting) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.0/cdn.min.js" defer></script>
  <!-- sql.js (SQLite in browser) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <!-- PayPal SDK (sandbox client-id 'sb' for demo) -->
  <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD" defer></script>

  <style>[x-cloak]{display:none!important}</style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="app()" x-init="init()">

  <!-- NAV -->
  <nav class="bg-blue-600 text-white p-4 shadow">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
      <h1 class="text-lg font-bold">Service Management</h1>
      <div class="flex items-center gap-4">
        <template x-if="user.loggedIn">
          <div class="text-sm">
            <span x-text="user.role === 'admin' ? 'Admin' : user.name"></span>
            <span class="text-blue-200 ml-2 text-xs" x-show="user.role === 'customer'" x-text="'(' + user.email + ')'"></span>
          </div>
        </template>
        <template x-if="!user.loggedIn">
          <button @click="showLogin = true" class="bg-white text-blue-600 px-3 py-1 rounded">Login</button>
        </template>
        <template x-if="user.loggedIn">
          <button @click="logout()" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded">Logout</button>
        </template>
      </div>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto p-6">

    <!-- LOGIN MODAL -->
    <div x-show="showLogin" x-cloak class="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded shadow w-96">
        <h2 class="text-xl font-semibold mb-4">Login</h2>
        <form @submit.prevent="performLogin">
          <label class="block text-sm">Email</label>
          <input class="w-full border p-2 rounded mb-3" type="email" x-model="login.email" required />
          <label class="block text-sm">Password</label>
          <input class="w-full border p-2 rounded mb-4" type="password" x-model="login.password" required />
          <div class="flex justify-between items-center">
            <div class="text-xs text-gray-500">
              Admin: admin@demo.com / admin123<br>
              Demo: john@demo.com / password123
            </div>
            <div>
              <button type="button" @click="showLogin=false" class="mr-2 px-3 py-1 border rounded">Cancel</button>
              <button class="px-3 py-1 bg-blue-600 text-white rounded">Login</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- NON-LOGGED IN HOME -->
    <div x-show="!user.loggedIn" class="text-center py-20">
      <h2 class="text-2xl font-semibold mb-2">Service Management Demo</h2>
      <p class="text-gray-600 mb-6">Static hosting friendly: Alpine.js + sql.js (SQLite in browser) + PayPal sandbox</p>
      <div class="flex justify-center gap-3">
        <button @click="showLogin=true" class="bg-blue-600 text-white px-4 py-2 rounded">Login</button>
        <button @click="seedDemo()" class="bg-green-600 text-white px-4 py-2 rounded">Seed Demo Data</button>
      </div>
    </div>

    <!-- MAIN APP (after login) -->
    <div x-show="user.loggedIn" x-cloak>

      <!-- ADMIN UI -->
      <template x-if="user.role === 'admin'">
        <section class="space-y-6">
          <div class="flex justify-between items-center">
            <h2 class="text-xl font-semibold">Admin Dashboard</h2>
            <div class="flex gap-2">
              <button @click="activeTab='customers'" :class="activeTab==='customers' ? 'bg-white text-blue-600' : 'bg-blue-600 text-white' " class="px-3 py-1 rounded">Customers</button>
              <button @click="activeTab='templates'" :class="activeTab==='templates' ? 'bg-white text-blue-600' : 'bg-blue-600 text-white' " class="px-3 py-1 rounded">Service Templates</button>
              <button @click="activeTab='payments'" :class="activeTab==='payments' ? 'bg-white text-blue-600' : 'bg-blue-600 text-white' " class="px-3 py-1 rounded">Payments</button>
              <button @click="activeTab='reminders'" :class="activeTab==='reminders' ? 'bg-white text-blue-600' : 'bg-blue-600 text-white' " class="px-3 py-1 rounded">Reminders</button>
            </div>
          </div>

          <!-- CUSTOMERS TAB -->
          <div x-show="activeTab==='customers'">
            <div class="bg-white p-5 rounded shadow">
              <div class="flex justify-between mb-4">
                <h3 class="font-semibold">Customers</h3>
                <div>
                  <button @click="openAddCustomer()" class="bg-green-600 text-white px-3 py-1 rounded">Add Customer</button>
                </div>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-left">
                  <thead class="text-xs text-gray-500 border-b">
                    <tr><th class="py-2">Name</th><th>Email</th><th>Services</th><th>Actions</th></tr>
                  </thead>
                  <tbody>
                    <template x-for="c in customers" :key="c.id">
                      <tr class="border-b">
                        <td class="py-2" x-text="c.name"></td>
                        <td x-text="c.email"></td>
                        <td x-text="countServices(c.id)"></td>
                        <td class="py-2">
                          <button @click="openAddService(c)" class="text-green-600 mr-3">Add Service</button>
                          <button @click="viewCustomer(c)" class="text-blue-600 mr-3">View</button>
                          <button @click="sendReminder(c)" class="text-yellow-600">Send Reminder</button>
                        </td>
                      </tr>
                    </template>
                    <tr x-show="customers.length===0"><td colspan="4" class="py-4 text-gray-500">No customers yet.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- TEMPLATES TAB -->
          <div x-show="activeTab==='templates'">
            <div class="bg-white p-5 rounded shadow">
              <div class="flex justify-between mb-4">
                <h3 class="font-semibold">Service Templates</h3>
                <div>
                  <button @click="openAddTemplate()" class="bg-green-600 text-white px-3 py-1 rounded">Add Template</button>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <template x-for="t in templates" :key="t.id">
                  <div class="border p-4 rounded">
                    <div class="flex justify-between">
                      <h4 class="font-semibold" x-text="t.name"></h4>
                      <div class="text-sm text-gray-500">Monthly $<span x-text="t.monthly_price"></span></div>
                    </div>
                    <p class="text-sm text-gray-600" x-text="t.description"></p>
                    <div class="mt-3 flex gap-2">
                      <button @click="editTemplate(t)" class="text-blue-600">Edit</button>
                      <button @click="deleteTemplate(t)" class="text-red-600">Delete</button>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- PAYMENTS TAB -->
          <div x-show="activeTab==='payments'">
            <div class="bg-white p-5 rounded shadow">
              <h3 class="font-semibold mb-4">Payments</h3>
              <div class="overflow-x-auto">
                <table class="w-full text-left">
                  <thead class="text-xs text-gray-500 border-b">
                    <tr><th>Customer</th><th>Service</th><th>Amount</th><th>Type</th><th>Status</th><th>Date</th><th>Action</th></tr>
                  </thead>
                  <tbody>
                    <template x-for="p in payments" :key="p.id">
                      <tr class="border-b">
                        <td x-text="getCustomerName(p.customer_id)"></td>
                        <td x-text="getServiceName(p.service_id)"></td>
                        <td>$<span x-text="p.amount"></span></td>
                        <td x-text="p.payment_type"></td>
                        <td x-text="p.status"></td>
                        <td x-text="p.payment_date"></td>
                        <td>
                          <button x-show="p.status==='processing'" @click="completeRenewal(p)" class="text-green-600">Complete Renewal</button>
                        </td>
                      </tr>
                    </template>
                    <tr x-show="payments.length===0"><td colspan="7" class="py-4 text-gray-500">No payments yet.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- REMINDERS TAB -->
          <div x-show="activeTab==='reminders'">
            <div class="bg-white p-5 rounded shadow">
              <h3 class="font-semibold mb-4">Upcoming Renewals (next 30 days)</h3>
              <div class="overflow-x-auto">
                <table class="w-full text-left">
                  <thead class="text-xs text-gray-500 border-b">
                    <tr><th>Customer</th><th>Service</th><th>Renewal</th><th>Days Left</th><th>Action</th></tr>
                  </thead>
                  <tbody>
                    <template x-for="row in upcoming" :key="row.service.id">
                      <tr class="border-b">
                        <td x-text="getCustomerName(row.service.customer_id)"></td>
                        <td x-text="row.service.service_name"></td>
                        <td x-text="row.service.renewal_date"></td>
                        <td x-text="row.days"></td>
                        <td><button @click="sendReminderById(row.service.customer_id,row.service)" class="text-yellow-600">Send Reminder</button></td>
                      </tr>
                    </template>
                    <tr x-show="upcoming.length===0"><td colspan="5" class="py-4 text-gray-500">No upcoming renewals.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        </section>
      </template>

      <!-- CUSTOMER UI -->
      <template x-if="user.role === 'customer'">
        <section>
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">My Services</h2>
            <div class="text-sm text-gray-600">Welcome, <span x-text="user.name"></span></div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <template x-for="s in myServices" :key="s.id">
              <div class="bg-white p-4 rounded shadow">
                <div class="flex justify-between items-start">
                  <div>
                    <h4 class="font-semibold" x-text="s.service_name"></h4>
                    <template x-if="s.domain">
                      <div class="text-xs text-blue-600 mt-1">
                        <span x-text="s.service_name.toLowerCase().includes('domain') ? 'Domain: ' + s.domain : (s.service_name.toLowerCase().includes('hosting') ? 'Hosting for: ' + s.domain : (s.service_name.toLowerCase().includes('email') ? 'Email for: ' + s.domain : ''))"></span>
                      </div>
                    </template>
                    <div class="text-xs text-gray-500">Renewal: <span x-text="s.renewal_date"></span></div>
                    <div class="text-xs text-gray-500">Days left: <span x-text="daysUntil(s.renewal_date)"></span></div>
                  </div>
                  <div>
                    <span :class="s.payment_status==='processing' ? 'bg-yellow-100 text-yellow-800' : daysUntil(s.renewal_date) < 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'"
                          class="px-2 py-1 text-xs font-semibold rounded-full" x-text="s.payment_status === 'processing' ? 'processing' : (daysUntil(s.renewal_date) < 0 ? 'expired' : (daysUntil(s.renewal_date) <=30 ? 'expiring' : 'active'))"></span>
                  </div>
                </div>
                <div class="mt-4 space-y-2">
                  <div class="flex justify-between">
                    <div>Monthly</div><div>$<span x-text="s.monthly_price"></span></div>
                  </div>
                  <div class="flex justify-between">
                    <div>Yearly</div><div>$<span x-text="s.yearly_price"></span></div>
                  </div>
                  <div class="space-y-2">
                    <div>
                      <button @click="startPay(s,'monthly')" class="w-full bg-blue-600 text-white py-2 rounded">Renew Monthly ($<span x-text="s.monthly_price"></span>)</button>
                    </div>
                    <div>
                      <button @click="startPay(s,'yearly')" class="w-full bg-green-600 text-white py-2 rounded">Renew Yearly ($<span x-text="s.yearly_price"></span>)</button>
                    </div>
                  </div>
                  <div class="mt-3" x-show="payingFor && payingFor.id === s.id">
                      <div :id="'paypal-button-container-' + s.id" class="mt-2"></div>
                      <div class="text-xs text-gray-500 mt-2">Using PayPal Sandbox (demo). After approval, admin will complete renewal.</div>
                  </div>
                </div>
              </div>
            </template>
            <div x-show="myServices.length===0" class="col-span-3 bg-white p-4 rounded shadow text-center text-gray-500">No services assigned.</div>
          </div>
        </section>
      </template>

    </div>
  </main>

  <!-- MODALS: Add Customer, Add Template, Add Service -->
  <div x-show="modal==='addCustomer'" x-cloak class="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
    <div class="bg-white p-5 rounded w-96">
      <h3 class="font-semibold mb-3">Add Customer</h3>
      <form @submit.prevent="doAddCustomer">
        <label class="text-sm">Name</label>
        <input class="w-full border p-2 rounded mb-2" x-model="formCustomer.name" required />
        <label class="text-sm">Email</label>
        <input class="w-full border p-2 rounded mb-2" type="email" x-model="formCustomer.email" required />
        <label class="text-sm">Password</label>
        <input class="w-full border p-2 rounded mb-4" type="password" x-model="formCustomer.password" required />
        <div class="flex justify-end gap-2">
          <button type="button" @click="modal=''" class="px-3 py-1 border rounded">Cancel</button>
          <button class="px-3 py-1 bg-blue-600 text-white rounded">Add</button>
        </div>
      </form>
    </div>
  </div>

  <div x-show="modal==='addTemplate'" x-cloak class="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
    <div class="bg-white p-5 rounded w-96">
      <h3 class="font-semibold mb-3">Add Template</h3>
      <form @submit.prevent="doAddTemplate">
        <label class="text-sm">Service Name</label>
        <input class="w-full border p-2 rounded mb-2" x-model="formTemplate.name" required />
        <label class="text-sm">Description</label>
        <textarea class="w-full border p-2 rounded mb-2" x-model="formTemplate.description"></textarea>
        <label class="text-sm">Monthly Price</label>
        <input class="w-full border p-2 rounded mb-2" type="number" step="0.01" x-model="formTemplate.monthly_price" required />
        <label class="text-sm">Yearly Price</label>
        <input class="w-full border p-2 rounded mb-4" type="number" step="0.01" x-model="formTemplate.yearly_price" required />
        <div class="flex justify-end gap-2">
          <button type="button" @click="modal=''" class="px-3 py-1 border rounded">Cancel</button>
          <button class="px-3 py-1 bg-blue-600 text-white rounded">Add</button>
        </div>
      </form>
    </div>
  </div>

  <div x-show="modal==='addService'" x-cloak class="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
    <div class="bg-white p-5 rounded w-96">
      <h3 class="font-semibold mb-3">Add Service to <span x-text="formService.customer_name"></span></h3>
      <form @submit.prevent="doAddService">
        <label class="text-sm">Template</label>
        <select class="w-full border p-2 rounded mb-2" x-model="formService.template_id" required @change="onTemplateChange()">
          <option value="">-- select --</option>
          <template x-for="t in templates" :key="t.id">
            <option :value="t.id" x-text="t.name + ' - $' + t.monthly_price + '/mo'"></option>
          </template>
        </select>
        <template x-if="formService.showDomain">
          <div>
            <label class="text-sm" x-text="formService.domainLabel"></label>
            <input class="w-full border p-2 rounded mb-2" x-model="formService.domain" placeholder="e.g. www.example.com" required />
          </div>
        </template>
        <label class="text-sm">Renewal Date</label>
        <input class="w-full border p-2 rounded mb-4" type="date" x-model="formService.renewal_date" required />
        <div class="flex justify-end gap-2">
          <button type="button" @click="modal=''" class="px-3 py-1 border rounded">Cancel</button>
          <button class="px-3 py-1 bg-blue-600 text-white rounded">Add</button>
        </div>
      </form>
    </div>
  </div>

  <!-- SCRIPT: APP LOGIC -->
  <script src="app.js"> 
  </script>
</body>
</html>
